<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
    <style>
      .map {
        height: 600px;
        width: 100%;
      }
      .cont {
        text-align: center;
        min-height: 200px;
      }
      .menu {
        display: inline-flex;
        width: 80%;
        margin: auto;
        margin-top: 20px;
      }
      .menu > span {
        margin: auto;
        padding: 2px;
        cursor: pointer;
      }

      .loader {
        color: darkblue;
        font-size: 90px;
        text-indent: -9999em;
        overflow: hidden;
        width: 1em;
        height: 1em;
        border-radius: 50%;
        margin: 72px auto;
        position: relative;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-animation: load6 1.7s infinite ease, round 1.7s infinite ease;
        animation: load6 1.7s infinite ease, round 1.7s infinite ease;
      }
      @-webkit-keyframes load6 {
        0% {
          box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
        }
        5%,
        95% {
          box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
        }
        10%,
        59% {
          box-shadow: 0 -0.83em 0 -0.4em, -0.087em -0.825em 0 -0.42em, -0.173em -0.812em 0 -0.44em, -0.256em -0.789em 0 -0.46em, -0.297em -0.775em 0 -0.477em;
        }
        20% {
          box-shadow: 0 -0.83em 0 -0.4em, -0.338em -0.758em 0 -0.42em, -0.555em -0.617em 0 -0.44em, -0.671em -0.488em 0 -0.46em, -0.749em -0.34em 0 -0.477em;
        }
        38% {
          box-shadow: 0 -0.83em 0 -0.4em, -0.377em -0.74em 0 -0.42em, -0.645em -0.522em 0 -0.44em, -0.775em -0.297em 0 -0.46em, -0.82em -0.09em 0 -0.477em;
        }
        100% {
          box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
        }
      }
      @keyframes load6 {
        0% {
          box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
        }
        5%,
        95% {
          box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
        }
        10%,
        59% {
          box-shadow: 0 -0.83em 0 -0.4em, -0.087em -0.825em 0 -0.42em, -0.173em -0.812em 0 -0.44em, -0.256em -0.789em 0 -0.46em, -0.297em -0.775em 0 -0.477em;
        }
        20% {
          box-shadow: 0 -0.83em 0 -0.4em, -0.338em -0.758em 0 -0.42em, -0.555em -0.617em 0 -0.44em, -0.671em -0.488em 0 -0.46em, -0.749em -0.34em 0 -0.477em;
        }
        38% {
          box-shadow: 0 -0.83em 0 -0.4em, -0.377em -0.74em 0 -0.42em, -0.645em -0.522em 0 -0.44em, -0.775em -0.297em 0 -0.46em, -0.82em -0.09em 0 -0.477em;
        }
        100% {
          box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
        }
      }
      @-webkit-keyframes round {
        0% {
          -webkit-transform: rotate(0deg);
          transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }
      @keyframes round {
        0% {
          -webkit-transform: rotate(0deg);
          transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
        }
      }

    </style>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cuid/1.3.8/browser-cuid.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/animate.css/animate.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/rmodal/dist/rmodal.css" type="text/css" />
    <script type="text/javascript" src="https://unpkg.com/rmodal/dist/rmodal.js"></script>
    <title>Intervisibility with GRASS r.viewshed</title>
  </head>
  <body>
    <h4></h4>
    <div id="map" class="map"></div>
    <div class="cont">
      <div class="menu">
        <button style="margin: auto;" id="compute_viewshed">Calculer bassin de visibilit√©</button>
        <button style="margin: auto;" id="compute_sunmask">Calculer Soleil-Ombre autour du centre de la carte</button>
      </div>
      <div style="display:none;" class="loader">Computing viewshed...</div>
    </div>
    <div id="modal-interviz" class="modal">
      <div class="modal-dialog animated">
          <div class="modal-content">
              <form class="form-horizontal" method="get">
                  <div class="modal-header">
                      <strong>Options</strong>
                  </div>
                  <div class="modal-body">
                    <div style="display: table-caption;">
                      <p><span>Height 1</span><input id="h1-input" min="0.0" type="number" step="0.1"></input></p>
                      <p><span>Height 2</span><input id="h2-input" min="0.0" type="number" step="0.1"></input></p>
                      <p><span>Max distance (km)</span><input id="mdist-input" type="number" min="0.0" max="75" step="0.1"></input></p>
                    </div>
                    <div id="coords-location" style="padding: 5px;font-size: 0.8em;font-style: italic;">
                    </div>
                    <div id="modal-error" style="background: red; display: none; color: white; font-weight: bold;">
                      Expected a number !
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="btn" id="cancel-modal">
                        Cancel
                    </button>
                      <button class="btn btn-primary" id="close-modal">
                          Compute
                      </button>
                  </div>
              </form>
          </div>
      </div>
  </div>
  <div id="modal-sunmask" class="modal">
    <div class="modal-dialog animated">
        <div class="modal-content">
            <form class="form-horizontal" method="get">
                <div class="modal-header">
                    <strong>Options</strong>
                </div>
                <div class="modal-body">
                  <div style="display: table-caption;">
                    <p><span>Year</span><input id="year-input" type="number" min="1950" max="2020" step="1"></input></p>
                    <p><span>Month</span><input id="month-input" type="number" min="1" max="12" step="1"></input></p>
                    <p><span>Day</span><input id="day-input" type="number" min="1" max="31" step="1"></input></p>
                    <p><span>Hour</span><input id="hour-input" type="number" min="0" max="23" step="1"></input></p>
                    <p><span>Minute</span><input id="minute-input" type="number" min="0" max="59" step="1"></input></p>
                  </div>
                  <div id="coords-location" style="padding: 5px;font-size: 0.8em;font-style: italic;">
                  </div>
                  <div id="modal-error" style="background: red; display: none; color: white; font-weight: bold;">
                    Expected a number !
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn" id="cancel-modal">
                      Cancel
                  </button>
                    <button class="btn btn-primary" id="close-modal">
                        Compute
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    <script type="text/javascript">

const getRandomRgba = (a = 255) => {
  const num = Math.round(0xffffff * Math.random());
  return `rgb(${num >> 16}, ${num >> 8 & 255}, ${num & 255}, ${a})`;
};

const is_num = (n) => typeof n === 'number'
  ? !isNaN(n)
  : !isNaN(n) && !isNaN(parseFloat(n));

const App = {
  map: {
    zoom: 14.4,
    center: ol.proj.fromLonLat([5.785, 45.29]),
    rotation: 0,
  },
};

const modal_interviz = new RModal(document.getElementById('modal-interviz'));
const modal_sunmask = new RModal(document.getElementById('modal-sunmask'));

if (window.location.hash !== '') {
  // try to restore center, zoom-level and rotation from the URL
  var hash = window.location.hash.replace('#map=', '');
  var parts = hash.split('/');
  if (parts.length === 4) {
    App.map.zoom = parseInt(parts[0], 10);
    App.map.center = [
      parseFloat(parts[1]),
      parseFloat(parts[2])
    ];
    App.map.rotation = parseFloat(parts[3]);
  }
}

const scaleLineControl = new ol.control.ScaleLine(); //Map scale bar
scaleLineControl.setUnits("metric");
const map_div = document.getElementById('map');
const map = new ol.Map({
  target: "map",
  layers: [
    new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: 'https://{a-c}.tile.opentopomap.org/{z}/{x}/{y}.png'
      })
    }),
  ],
  view: new ol.View({
    center: App.map.center, // 5.72, 45.18
    zoom: App.map.zoom,
  }),
  controls: ol.control.defaults({
    zoom : false,
    attributionOptions: {
      collapsible: false
    },
  }).extend([ scaleLineControl ])
});

// let our_layers = {};

let shouldUpdate;
const updatePermalink = (() => {
  const view = map.getView();
  const round = Math.round;
  return () => {
    if (!shouldUpdate) {
      // do not update the URL when the view was changed in the 'popstate' handler
      shouldUpdate = true;
      return;
    }
    var center = view.getCenter();
    var hash = '#map=' +
        view.getZoom() + '/' +
        round(center[0] * 100) / 100 + '/' +
        round(center[1] * 100) / 100 + '/' +
        view.getRotation();
    var state = {
      zoom: view.getZoom(),
      center: view.getCenter(),
      rotation: view.getRotation()
    };
    window.history.pushState(state, 'map', hash);
  };
})();

map.on('moveend', updatePermalink);

window.addEventListener('popstate', function(event) {
  if (event.state === null) {
    return;
  }
  map.getView().setCenter(event.state.center);
  map.getView().setZoom(event.state.zoom);
  map.getView().setRotation(event.state.rotation);
  shouldUpdate = false;
});

function sunmaskEndModal() {
  let year = document.getElementById('year-input');
  let month = document.getElementById('month-input');
  let day = document.getElementById('day-input');
  let hour = document.getElementById('hour-input');
  let minute = document.getElementById('minute-input');
  if (!is_num(year.value) || !is_num(month.value) || !is_num(day.value)
        || !is_num(hour.value) || !is_num(minute.value)) {
    document.querySelector('#modal-sunmask #modal-error').style.display = null;
    return;
  }
  updatePermalink();
  modal_sunmask.close();
  let coords = ol.proj.toLonLat(map.getView().getCenter());
  fetch(`/sunmask?year=${year.value}&month=${month.value}&day=${day.value}&hour=${hour.value}&minute=${minute.value}&center=${coords[1]},${coords[0]}`, {
    method: 'GET',
  })
  .then(res => res.json())
  .then((res) => {
    document.querySelector('.loader').style.display = 'none';
    let _geojson_vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({
          features: (new ol.format.GeoJSON()).readFeatures(res, {
              featureProjection: 'EPSG:3857'
          }),
        }),
      style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'darkgreen',
            width: 1,
          }),
          fill: new ol.style.Fill({
            color: 'rgba(20, 200, 20, 0.45)',
          })
        })
      });
      map.addLayer(_geojson_vectorLayer);
  })
  .catch((err) => {
    document.querySelector('.loader').style.display = 'none';
    console.log(err);
  });
  year.value = 2019;
  month.value = 1;
  day.value = 1;
  hour.value = 16;
  minute.value = 45;
}

document.getElementById('compute_sunmask').addEventListener('click', (event) => {
  modal_sunmask.open();
  document.querySelector('.loader').style.display = null;
});

document.getElementById('compute_viewshed').addEventListener('click', (event) => {
  if (map_div.style.cursor === 'crosshair') {
    map_div.style.cursor = null;
  } else {
    map_div.style.cursor = 'crosshair';
  }
});

map.on('click', (e) => {
  if (map_div.style.cursor === 'crosshair') {
    map_div.style.cursor = null;
    let coords = ol.proj.toLonLat(e.coordinate);
    updatePermalink();
    document.getElementById('coords-location').innerHTML = `${coords[1]},${coords[0]}`;
    document.querySelector('.loader').style.display = null;
    modal_interviz.open();
  }
});


function intervizEndModal() {
  let h1 = document.getElementById('h1-input');
  let h2 = document.getElementById('h2-input');
  let mdist = document.getElementById('mdist-input');
  let c = document.getElementById('coords-location');
  let _c = c.innerHTML.split(',').map(a => +a);
  if (!is_num(h1.value) || !is_num(h2.value) || !is_num(mdist.value)) {
    document.querySelector('#modal-interviz #modal-error').style.display = null;
    return;
  }
  modal_interviz.close();
  fetch(`/viewshed?coordinates=${c.innerHTML}&height1=${h1.value}&height2=${h2.value}&max_distance=${Math.round(+mdist.value * 1000)}`, {
    method: 'GET',
  })
    .then(res => res.json())
    .then((res) => {
      document.querySelector('.loader').style.display = 'none';
      let features = [];
      features.push(new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.transform([_c[1], _c[0]], 'EPSG:4326', 'EPSG:3857')),
      }))
      features = features.concat((new ol.format.GeoJSON()).readFeatures(res, {
          featureProjection: 'EPSG:3857'
      }))
      let _geojson_vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: features,
          }),
        style: function(feature) {
            if (feature.getGeometry().getType() === 'Point') {
              return new ol.style.Style({
                  image: new ol.style.Circle({
                    radius: 12,
                    fill: new ol.style.Fill({
                      color: 'orange'
                    })
                  }),
                });
            } else {
              return new ol.style.Style({
                  stroke: new ol.style.Stroke({
                    color: 'darkblue',
                    width: 1,
                  }),
                  fill: new ol.style.Fill({
                    color: 'rgba(200, 20, 20, 0.45)',
                  })
                });
            }
          }
        });
        map.addLayer(_geojson_vectorLayer);
    })
    .catch((err) => {
      document.querySelector('.loader').style.display = 'none';
      console.log(err);
    });
  h1.value = null;
  h2.value = null;
  c.innerHTML = '';
}

['interviz', 'sunmask']
  .forEach((name_func) => {
    Array.from(document.querySelectorAll(`#modal-${name_func} input`))
      .forEach((el) => {
        el.onchange = () => {
          document.querySelector(`#modal-${name_func} #modal-error`)
            .style.display = 'none';
        };
      });
    document.querySelector(`#modal-${name_func} #close-modal`)
      .onclick = this[`${name_func}EndModal`];
  });
  document.querySelector(`#modal-interviz #cancel-modal`)
    .onclick = () => { modal_interviz.close(); };
  document.querySelector(`#modal-sunmask #cancel-modal`)
    .onclick = () => { modal_sunmask.close(); };
    </script>
  </body>
</html>
